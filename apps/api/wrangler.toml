name = "finhome" # Aligned with CI expected Worker name to avoid duplicate script creation causing queue consumer conflicts
main = "src/index.ts"
compatibility_date = "2023-12-01"
compatibility_flags = ["nodejs_compat"]

# Cloudflare Workers Configuration
workers_dev = true

# Custom Domain for API
[[routes]]
pattern = "api.finhome360.com"
custom_domain = true

# D1 Database (production)
[[d1_databases]]
binding = "DB"
database_name = "finhome-db"
database_id = "1115b8c7-85fd-4ce8-a553-8fe85fb5b629"
migrations_dir = "drizzle/migrations"

# KV Namespaces (production)
[[kv_namespaces]]
binding = "SESSIONS"
id = "17af1f0cba5940188630322248a86071"

[[kv_namespaces]]
binding = "CACHE"
id = "ec9376073fb34ebd9f1dcabbc3cc39ae"

# R2 Buckets
[[r2_buckets]]
binding = "FILES"
bucket_name = "finhome-files"

# Queues
[[queues.producers]]
binding = "BILL_REMINDERS"
queue = "finhome-bill-reminders"

[[queues.consumers]]
queue = "finhome-bill-reminders"
max_batch_size = 10
max_batch_timeout = 30

[[queues.producers]]
binding = "TRANSACTION_SYNC"
queue = "finhome-transaction-sync"

[[queues.consumers]]
queue = "finhome-transaction-sync"
max_batch_size = 5
max_batch_timeout = 30

# Cron Triggers - Automatic sync every 6 hours
[triggers]
crons = ["0 */6 * * *"]

# AI Binding
[ai]
binding = "AI"

# Environment Variables
# Non-sensitive configuration
[vars]
ENVIRONMENT = "production"
FRONTEND_URL = "https://app.finhome360.com"
TRUELAYER_REDIRECT_URI = "https://api.finhome360.com/api/banking/callback"
TRUELAYER_CLIENT_ID = "finhome360-366caa"  # Client ID is public (not secret)

# Sensitive values should be set via wrangler secret put command or GitHub Actions secrets:
# wrangler secret put JWT_SECRET
# wrangler secret put RESEND_API_KEY
# wrangler secret put TRUELAYER_CLIENT_SECRET
# wrangler secret put ADMIN_FIX_SECRET_KEY
# Durable Objects (for future use)
# [[durable_objects.bindings]]
# name = "ANALYTICS"
# class_name = "AnalyticsCounter"
# script_name = "finhome-api"
